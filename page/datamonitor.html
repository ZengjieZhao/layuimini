<style>
    .top-panel {
        border: 1px solid #eceff9;
        border-radius: 5px;
        text-align: center;
    }

    .top-panel>.layui-card-body {
        height: 60px;
    }

    .top-panel-number {
        line-height: 60px;
        font-size: 30px;
        border-right: 1px solid #eceff9;
    }

    .top-panel-tips {
        line-height: 30px;
        font-size: 12px
    }
</style>
<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main welcome">

        <div class="layui-row layui-col-space15">
            <div class="layui-col-xs6 layui-col-md6">
                <div id="temperature" style="background-color:#ffffff;height: 300px;padding: 10px"></div>
            </div>
            <div class="layui-col-xs6 layui-col-md6">
                <div id="humidity" style="background-color:#ffffff;height: 300px;padding: 10px"></div>
            </div>
        </div>
    </div>
</div>
<script>
    layui.use(['layer', 'echarts'], function () {
        var $ = layui.jquery,
            layer = layui.layer,
            echarts = layui.echarts;

        var humidityX = [];
        var humidityY = [];
        var temperatureX = [];
        var temperatureY = [];
        var temperatureChartDom = document.getElementById('temperature');
        var temperatureChart = echarts.init(temperatureChartDom);
        var humidityChartDom = document.getElementById('humidity');
        var humidityChart = echarts.init(humidityChartDom);

        var temperatureOption;
        temperatureOption = {
            title: {
                left: 'center',
                text: '温度折线数据',
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            toolbox: {
                show: true,
                feature: {
                    dataZoom: {
                        yAxisIndex: 'none'
                    },
                    dataView: { readOnly: false },
                    magicType: { type: ['line', 'bar'] },
                    restore: {},
                    saveAsImage: {}
                }
            },
            animation:true,
            xAxis: {
                type: 'category'
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    formatter: '{value} °C'
                }
            },
            series: [{
                name: '温度',
                type: 'line',
                itemStyle: {
                        normal: {
                            label : {show: true},
                            color: '#6aa84f'
                        }
                    }
            }]
        };

        temperatureChart.setOption(temperatureOption);


        var humidityOption;
        humidityOption = {
            title: {
                left: 'center',
                text: '湿度折线数据',
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            toolbox: {
                show: true,
                feature: {
                    dataZoom: {
                        yAxisIndex: 'none'
                    },
                    dataView: { readOnly: false },
                    magicType: { type: ['line', 'bar'] },
                    restore: {},
                    saveAsImage: {}
                }
            },
            animation:true,
            xAxis: {
                type: 'category'
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    formatter: '{value} %RH'
                }
            },
            series: [{
                name: '湿度',
                type: 'line',
                itemStyle: {
                        normal: {
                            label : {show: true},
                            color: '#6aa84f'
                        }
                    }
            }]
        };
        humidityChart.setOption(humidityOption);

        //首次加载
        $.ajax(
                {
                    url: "http://127.0.0.1:8098/datapoint/recent20?deviceId=1",
                    method: "get",
                    dataType: 'json',
                    success: function (res) {
                        var temps = res.temp;
                        $.each(temps, function (index, value) {
                            // console.log(index + " : " + value);
                            var date = new Date(value[0]);
                            var hms = (date.getHours() >= 10 ? date.getHours() : '0' + date.getHours()) + ':' +
                                (date.getMinutes() >= 10 ? date.getMinutes() : '0' + date.getMinutes()) +
                                ':' + (date.getSeconds() >= 10 ? date.getSeconds() : '0' + date.getSeconds());
                            temperatureX.push(hms);
                            temperatureY.push(value[1]);
                        });
                        var hums = res.hum;
                        $.each(hums, function (index, value) {
                            // console.log(index + " : " + value);
                            var date = new Date(value[0]);
                            var hms = (date.getHours() >= 10 ? date.getHours() : '0' + date.getHours()) + ':' +
                                (date.getMinutes() >= 10 ? date.getMinutes() : '0' + date.getMinutes()) +
                                ':' + (date.getSeconds() >= 10 ? date.getSeconds() : '0' + date.getSeconds());
                            
                            humidityX.push(hms);
                            humidityY.push(value[1]);
                        });
                        temperatureChart.setOption({
                            xAxis: {
                                data: temperatureX
                            },
                            series: [{
                                data: temperatureY
                            }]
                        });
                        humidityChart.setOption({
                            xAxis: {
                                data: humidityX
                            },
                            series: [{
                                data: humidityY
                            }]
                        });
                    },
                    error: function (res) {
                        console.log('error');
                        console.log(res);
                    }
                }
            );
        setInterval(function () {
            $.ajax(
                {
                    url: "http://127.0.0.1:8098/datapoint/recent20?deviceId=1",
                    method: "get",
                    dataType: 'json',
                    success: function (res) {
                        var temps = res.temp;
                        $.each(temps, function (index, value) {
                            // console.log(index + " : " + value);
                            var date = new Date(value[0]);
                            var hms = (date.getHours() >= 10 ? date.getHours() : '0' + date.getHours()) + ':' +
                                (date.getMinutes() >= 10 ? date.getMinutes() : '0' + date.getMinutes()) +
                                ':' + (date.getSeconds() >= 10 ? date.getSeconds() : '0' + date.getSeconds());
                            temperatureX.shift();
                            temperatureX.push(hms);
                            temperatureY.shift();
                            temperatureY.push(value[1]);
                        });
                        var hums = res.hum;
                        $.each(hums, function (index, value) {
                            // console.log(index + " : " + value);
                            var date = new Date(value[0]);
                            var hms = (date.getHours() >= 10 ? date.getHours() : '0' + date.getHours()) + ':' +
                                (date.getMinutes() >= 10 ? date.getMinutes() : '0' + date.getMinutes()) +
                                ':' + (date.getSeconds() >= 10 ? date.getSeconds() : '0' + date.getSeconds());
                            
                            humidityX.shift();
                            humidityX.push(hms);
                            humidityY.shift();
                            humidityY.push(value[1]);
                        });
                        temperatureChart.setOption({
                            xAxis: {
                                data: temperatureX
                            },
                            series: [{
                                data: temperatureY
                            }]
                        });
                        humidityChart.setOption({
                            xAxis: {
                                data: humidityX
                            },
                            series: [{
                                data: humidityY
                            }]
                        });
                    },
                    error: function (res) {
                        console.log('error');
                        console.log(res);
                    }
                }
            );
        }, 2000);
        // echarts 窗口缩放自适应
        window.onresize = function () {
            temperatureChart.resize();
            humidityChart.resize();
        }

    });
</script>